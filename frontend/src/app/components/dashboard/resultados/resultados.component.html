<div class="resultados-container">
  <!-- Estado de carga -->
  <div class="loading-indicator" *ngIf="cargando">
    <div class="spinner"></div>
    <p>Cargando respuestas de usuarios...</p>
  </div>

  <!-- Mensaje de error -->
  <div class="error-message" *ngIf="error">
    <p>{{ error }}</p>
    <button (click)="cargarTablaCalificacionRiesgo()">Reintentar</button>
  </div>

  <!-- Contenido principal - Lista de respuestas por usuario -->
  <div class="respuestas-usuarios" *ngIf="!cargando && !error">
    <h2>Respuestas de Usuarios con Nivel de Riesgo</h2>
    
    <!-- Información sobre la valoración de respuestas -->
    <div class="valoracion-info">
      <h3>Valoración de respuestas:</h3>
      <div class="tablas-valoracion">
        <div class="tabla-valoracion tabla-inversa">
          <h4>Ítems con valoración inversa:</h4>
          <table>
            <thead>
              <tr>
                <th>Respuesta</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Siempre</td><td>0</td></tr>
              <tr><td>Casi siempre</td><td>1</td></tr>
              <tr><td>Algunas veces</td><td>2</td></tr>
              <tr><td>Casi nunca</td><td>3</td></tr>
              <tr><td>Nunca</td><td>4</td></tr>
            </tbody>
          </table>
          <div class="items-list">
            <strong>Ítems:</strong> 1, 4, 23, 24, 25, 26, 27, 28, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 55, 56, 57
          </div>
        </div>
        <div class="tabla-valoracion tabla-normal">
          <h4>Ítems con valoración normal:</h4>
          <table>
            <thead>
              <tr>
                <th>Respuesta</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>Siempre</td><td>4</td></tr>
              <tr><td>Casi siempre</td><td>3</td></tr>
              <tr><td>Algunas veces</td><td>2</td></tr>
              <tr><td>Casi nunca</td><td>1</td></tr>
              <tr><td>Nunca</td><td>0</td></tr>
            </tbody>
          </table>
          <div class="items-list">
            <strong>Ítems:</strong> 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 29, 54, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72
          </div>
        </div>
      </div>
    </div>

    <!-- Información sobre las categorías -->
    <div class="categorias-info">
      <h3>Categorías de preguntas:</h3>
      <div class="categorias-grid">
        <div class="categoria-card" *ngFor="let categoria of categorias">
          <h4>{{ categoria.nombre }}</h4>
          <div class="categoria-items">
            <strong>Ítems:</strong> {{ categoria.preguntas.join(', ') }}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabla de calificación de nivel de riesgo -->
    <div class="tabla-riesgo-info">
      <h3>Niveles de riesgo por categoría:</h3>
      <div class="tabla-riesgo">
        <table>
          <thead>
            <tr>
              <th>Categoría</th>
              <th>Nulo o despreciable</th>
              <th>Bajo</th>
              <th>Medio</th>
              <th>Alto</th>
              <th>Muy alto</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let cat of tablaCalificacionRiesgo">
              <td class="categoria-cell">{{ cat.categoria }}</td>
              <td *ngFor="let nivel of cat.niveles"
                  [style.background-color]="nivel.color"
                  [style.color]="getColorTexto(nivel.color)">
                {{ nivel.rango }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Si no hay respuestas -->
    <div class="empty-results" *ngIf="respuestasUsuarios.length === 0">
      <p>No se encontraron respuestas de usuarios.</p>
    </div>
    
    <!-- Lista de usuarios con respuestas -->
    <div class="usuarios-list" *ngIf="respuestasUsuarios.length > 0">
      <div class="user-card" *ngFor="let item of respuestasUsuarios">
        <div class="user-header">
          <h3>{{ item.usuario.nombre }}</h3>
          <div class="user-meta">
            <span class="user-email">{{ item.usuario.email }}</span>
          </div>
        </div>
        
        <div class="user-stats">
          <div class="stat-item">
            <div class="stat-label">Evaluaciones respondidas:</div>
            <div class="stat-value">{{ item.usuario.total_respuestas }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Progreso total:</div>
            <div class="stat-value">{{ item.progreso.porcentajeTotal }}%</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Suma valores ajustados:</div>
            <div class="stat-value">{{ item.usuario.suma_valores_ajustados }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Preguntas obligatorias:</div>
            <div class="stat-value">{{ item.progreso.respondidasObligatorias }} / {{ item.progreso.totalObligatorias }}</div>
          </div>
          <div class="stat-item" *ngIf="item.progreso.esJefe">
            <div class="stat-label">Preguntas opcionales:</div>
            <div class="stat-value">{{ item.progreso.respondidasOpcionales }} / {{ item.progreso.totalOpcionales }}</div>
          </div>
        </div>
        
        <!-- Nivel de riesgo total del cuestionario -->
        <div class="riesgo-total" *ngIf="item.usuario.nivel_riesgo_total">
          <h4>Nivel de riesgo total</h4>
          <div class="riesgo-content">
            <div class="riesgo-badge" 
                 [style.background-color]="item.usuario.color_riesgo_total || '#d9d9d9'"
                 [style.color]="getColorTexto(item.usuario.color_riesgo_total || '#d9d9d9')">
              {{ item.usuario.nivel_riesgo_total }}
            </div>
            <div class="riesgo-info">
              <span class="riesgo-value">Valor total: {{ item.usuario.suma_valores_ajustados }}</span>
            </div>
          </div>
          
          <!-- Criterios para la toma de acciones -->
          <div class="criterios-accion">
            <h5>Criterios para la toma de acciones:</h5>
            <p>{{ getCriteriosAccion(item.usuario.nivel_riesgo_total) }}</p>
          </div>
        </div>

        <!-- Resumen por categoría con nivel de riesgo -->
        <div class="categoria-summary" *ngIf="item.usuario.sumasPorCategoria && item.usuario.sumasPorCategoria.length > 0">
          <h4>Resumen por categoría</h4>
          <div class="categoria-stats">
            <div class="categoria-stat-item" *ngFor="let sumaCat of item.usuario.sumasPorCategoria"
                 [style.border-color]="sumaCat.color_riesgo">
              <div class="categoria-name">{{ sumaCat.categoria }}</div>
              <div class="categoria-values">
                <div class="sum-value">Suma: {{ sumaCat.suma }}</div>
                <div class="avg-value">Promedio: {{ (sumaCat.suma / sumaCat.totalPreguntas).toFixed(2) }}</div>
                <div class="risk-level" 
                     [style.background-color]="sumaCat.color_riesgo || '#d9d9d9'"
                     [style.color]="getColorTexto(sumaCat.color_riesgo || '#d9d9d9')">
                  {{ sumaCat.nivel_riesgo }}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Respuestas agrupadas por categoría -->
        <div class="respuestas-categorias">
          <h4>Respuestas por categoría</h4>
          
          <div class="accordion-container">
            <div class="accordion-item" *ngFor="let catId of getCategoriasIds(item.respuestas)">
              <!-- Buscar la categoría actual en la suma por categorías -->
              <ng-container *ngVar="getCategoriaById(item.usuario.sumasPorCategoria || [], catId) as catSuma">
                <!-- Usar el header con los datos de la categoría encontrada -->
                <div class="accordion-header" (click)="toggleAccordion($event)"
                     [style.border-left]="'5px solid ' + (catSuma?.color_riesgo || '#d9d9d9')">
                  <span class="categoria-title">{{ obtenerNombreCategoria(catId) }}</span>
                  <span class="risk-badge"
                       [style.background-color]="catSuma?.color_riesgo || '#d9d9d9'"
                       [style.color]="getColorTexto(catSuma?.color_riesgo || '#d9d9d9')">
                    {{ catSuma?.nivel_riesgo || 'Sin clasificar' }}
                  </span>
                  <span class="toggle-icon">▼</span>
                </div>
                <div class="accordion-content">
                  <div class="category-summary">
                    <div class="summary-row">
                      <div class="summary-label">Suma:</div>
                      <div class="summary-value">{{ catSuma?.suma || 0 }}</div>
                    </div>
                    <div class="summary-row">
                      <div class="summary-label">Total preguntas:</div>
                      <div class="summary-value">{{ catSuma?.totalPreguntas || 0 }}</div>
                    </div>
                  </div>
                  <div class="respuestas-table">
                    <table>
                      <thead>
                        <tr>
                          <th>Pregunta</th>
                          <th>Respuesta</th>
                          <th>Valor original</th>
                          <th>Valor ajustado</th>
                          <th>Tipo</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let resp of getRespuestasByCategoria(item.respuestas, catId)">
                          <td>{{ resp.pregunta_texto }}</td>
                          <td>{{ resp.respuesta_texto }}</td>
                          <td>{{ resp.respuesta_valor }}</td>
                          <td>{{ resp.valor_ajustado }}</td>
                          <td>{{ esItemInverso(resp.pregunta_orden) ? 'Inverso' : 'Normal' }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
